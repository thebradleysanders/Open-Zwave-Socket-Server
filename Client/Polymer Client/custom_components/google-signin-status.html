<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/google-signin/google-signin.html">
<link rel="import" href="../bower_components/google-apis/google-client-api.html">

<!--
Element providing information about the authenticated user.
Needs a google-signin element included somewhere on the same page
that handles authentication.
-->
<polymer-element name="google-signin-status">
	<template>
		<style>
			:host {
				display: inline-block;
				margin-top: 5px;
				width: 100%;
			}

			div {
				padding: 5px 10px;
			}
			
			p.center {
				margin-top: 0px;
				margin-bottom: 0px;
				text-align: center;
			}

			img {
				border-radius: 50%;
				max-width: 30px;
				max-height: 30px;
				display:block;
				margin-left:auto;
				margin-right:auto;
				margin-top:5px;
			}
		</style>

		<google-api-loader id="plus" name="plus" version="v1"
			on-google-api-load="{{displayProfile}}">
		</google-api-loader>
		<google-signin-aware
			scopes="profile"
			on-google-signin-aware-success="{{signIn}}"
			on-google-signin-aware-failure="{{signOut}}"
			on-google-signin-aware-signed-out="{{signOut}}">
		</google-signin-aware>

		<div>
			<template if="{{signedIn}}">
				<p class="center">{{profile.displayName}}</p>
				<a href="{{profile.url}}"><img src="{{profile.image.url}}" /></a>
			</template>
			<template if="{{!signedIn}}">
				<p class="center">Not signed in!</p>
			</template>
		</div>
	</template>
	<script>
		Polymer('google-signin-status', {
			publish: {
				profile: null,
			},
			
			signedIn: false,

			signIn: function (response) {
				this.signedIn = true;
				this.displayProfile();
				console.log("Signin Response",response);
				delete response.detail.result['g-oauth-window'];
				var commandstring = "AUTH~"+JSON.stringify(response.detail.result);
				this.fire('send-command',{command:commandstring});
			},

			signOut: function () {
				this.profile = null;
				this.signedIn = false;
			},

			displayProfile: function () {
				if (this.signedIn && this.$.plus.api) {
					var request = this.$.plus.api.people.get({"userId": "me"});
					request.execute(function (resp) {
						this.profile = resp;
					}.bind(this));
				}
			}
		});
	</script>
</polymer-element>